{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/blog/2020-09-14-netlify-is-slow/","result":{"data":{"markdownRemark":{"excerpt":"Netlify は遅い ここ数年、Netlify に大変お世話になってきました。とても便利で助かっているのですが、実はスループットがとても悪いということに気が付きました。 これに気づいたのは Storybook のサイトを構築したときでした。Storybook…","html":"<h2>Netlify は遅い</h2>\n<p>ここ数年、Netlify に大変お世話になってきました。とても便利で助かっているのですが、実はスループットがとても悪いということに気が付きました。</p>\n<p>これに気づいたのは Storybook のサイトを構築したときでした。Storybook は JavaScript のバンドルサイズがどうしても 2MB 程度になってしまうのですが、これをダウンロードするのに十数秒かかっていることが分かったのです。</p>\n<p>調べてみると、Netlify の無料プランの場合、CDN は世界で 8 箇所しかなく、日本は含まれていないそうです。サポートに問い合わせたところ、日本での CDN を有効にする場合は月額 3000 ドルから（！！！）のエンタープライズ契約が必須との回答でした。ありがとう Alejandra さん、ブッ飛んだぜ！</p>\n<p>代替手段を検討してみた結果をまとめたものが下記です。測定には<a href=\"https://www.fastorslow.com/\">fastorslow.com</a>などを使いました。</p>\n<table>\n<thead>\n<tr>\n<th>service</th>\n<th>price</th>\n<th>スループット</th>\n<th>RTT</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Netlify</td>\n<td>200GB まで無料<br/>以降従量制</td>\n<td>約 100KB/s</td>\n<td>約 50ms</td>\n</tr>\n<tr>\n<td>Github pages</td>\n<td>100GB まで無料<br/>超えたら追い出される(!)</td>\n<td>数 MB/s</td>\n<td>約 5ms</td>\n</tr>\n<tr>\n<td>Firebase hosting</td>\n<td>10GB まで無料<br/>以降従量制</td>\n<td>数 MB/s</td>\n<td>約 5ms</td>\n</tr>\n</tbody>\n</table>\n<p>Firebase と Github pages で悩みましたが、下記の理由から今回は github pages を利用することにしました。</p>\n<ul>\n<li>スループットやレイテンシにほぼ差がないこと</li>\n<li>デプロイの手間はどちらでもさして変わらかったこと(github actions 利用)</li>\n<li>無料枠が github pages のほうが大きいこと</li>\n</ul>\n<p>ちなみに、github actions は以下のようにしています。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> MyActions\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>push<span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy-to-github-pages</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># CD環境にコードをチェックアウト</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@master\n\n      <span class=\"token comment\"># Node.js環境のセットアップ</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@master\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'12.18.3'</span>\n\n      <span class=\"token comment\"># 効率化のためにnode_modulesをキャッシュする</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Cache node modules\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/cache@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> node_modules\n          <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> runner.OS <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>build<span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> hashFiles('<span class=\"token important\">**/yarn.lock')</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">restore-keys</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            ${{ runner.OS }}-build-${{ env.cache-name }}-\n            ${{ runner.OS }}-build-\n            ${{ runner.OS }}-</span>\n\n      <span class=\"token comment\"># npmパッケージのインストール</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> yarn\n\n      <span class=\"token comment\"># 静的ファイルのビルド</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> yarn build<span class=\"token punctuation\">-</span>storybook\n\n      <span class=\"token comment\"># gh-pagesブランチへ静的ファイルをプッシュ</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy to Github pages\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> peaceiris/actions<span class=\"token punctuation\">-</span>gh<span class=\"token punctuation\">-</span>pages@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token comment\"># GITHUB_TOKENは自動でセットされるので何もしなくてOK</span>\n          <span class=\"token key atrule\">github_token</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">publish_dir</span><span class=\"token punctuation\">:</span> ./storybook<span class=\"token punctuation\">-</span>static\n          <span class=\"token comment\"># 独自ドメインを使う場合には指定してください</span>\n          <span class=\"token key atrule\">cname</span><span class=\"token punctuation\">:</span> www.yuuniworks.com</code></pre></div>\n<p>上記を走らせると<code class=\"language-text\">gh-pages</code>ブランチに、指定したフォルダの内容がプッシュされます（上記では<code class=\"language-text\">./storybook-static</code>に生成されたファイル）。あとは github のコンソールから、pages として公開するブランチをポチッと選べば完了です。</p>\n<p>なお、独自ドメインを使用する場合は、DNS 設定において、<code class=\"language-text\">&lt;あなたのユーザ名&gt;.github.io</code>を値とする<code class=\"language-text\">CNAME</code>レコードを作成しておく必要があります。</p>","fields":{"slug":"/2020-09-14-netlify-is-slow/"},"frontmatter":{"title":"Netlifyは遅い","summary":"Netlifyはスループットが非常に悪いようです","date":"2020-09-14T15:00:00.000Z","dateModified":"2020-09-14T15:00:00.000Z","thumbnail":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2020-09-14-netlify-is-slow/","modifiedDate":"2020-09-14T15:00:00.000Z"}}}